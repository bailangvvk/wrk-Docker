name: Build and Push Wrk Image (Simple)

on:
  workflow_dispatch:
  push:
    branches: [ ssl ]
  # schedule:
  #   - cron: '0 3 * * *' # 每天构建一次（可选）

env:
  DOCKER_REPO: bailangvvking/wrk

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check Server Performance(检查服务器性能)
        run: |
          echo "警告⚠"
          echo "分配的服务器性能有限，若选择的插件过多，务必注意CPU性能！"
          echo -e "已知CPU型号（降序）：7763，8370C，8272CL，8171M，E5-2673 \n"
          echo "--------------------------CPU信息--------------------------"
          echo "CPU物理数量：$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo -e "CPU核心信息：$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo "--------------------------内存信息--------------------------"
          echo "已安装内存详细信息："
          echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
          echo "--------------------------硬盘信息--------------------------"
          echo "硬盘数量：$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker
        run: |
          echo "Docker版本:"
          docker --version
          echo "使用纯Docker构建，避免buildx网络问题"

      - name: Log in to DockerHub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image (amd64 only)
        run: |
          # 构建amd64架构镜像 - 重试机制应对网络问题
          for i in {1..3}; do
            echo "第 $i 次尝试构建镜像..."
            docker build -t ${{ env.DOCKER_REPO }}:ssl .
            if [ $? -eq 0 ]; then
              echo "构建成功!"
              break
            fi
            echo "构建失败，10秒后重试..."
            sleep 10
          done

          # 打标签
          docker tag ${{ env.DOCKER_REPO }}:ssl ${{ env.DOCKER_REPO }}:latest-amd64

      - name: Test the image
        run: |
          echo "测试镜像功能..."
          docker run --rm ${{ env.DOCKER_REPO }}:ssl --version || echo "测试失败，但继续构建流程"

      - name: Push Docker image
        run: |
          # 推送镜像到Docker Hub
          docker push ${{ env.DOCKER_REPO }}:ssl
